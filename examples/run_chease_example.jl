import Pkg
Pkg.activate(joinpath(dirname(abspath(@__FILE__)),".."))

import CHEASE:run_chease

μ_0 = 1.25663706212e-6

r_bound = [1.3907563, 1.39034904, 1.3891286, 1.38709902, 1.38426701,
1.38064191, 1.37623562, 1.37106255, 1.36513953, 1.3584857,
1.35112239, 1.34307303, 1.334363, 1.32501947, 1.31507127,
1.30454871, 1.29348345, 1.28190828, 1.269857, 1.25736421,
1.24446514, 1.2311955, 1.21759129, 1.20368862, 1.18952357,
1.17513203, 1.16054952, 1.14581109, 1.13095114, 1.11600331,
1.10100039, 1.08597415, 1.07095529, 1.05597334, 1.04105658,
1.02623195, 1.01152502, 0.99695997, 0.98255947, 0.96834473,
0.95433545, 0.94054983, 0.92700453, 0.91371473, 0.90069412,
0.88795492, 0.87550792, 0.86336251, 0.85152672, 0.84000728,
0.82880966, 0.81793812, 0.80739577, 0.79718461, 0.78730566,
0.77775892, 0.76854352, 0.75965773, 0.75109905, 0.74286428,
0.73494955, 0.7273504, 0.72006187, 0.71307849, 0.70639441,
0.7000034, 0.69389894, 0.68807425, 0.68252235, 0.67723609,
0.67220822, 0.66743139, 0.66289825, 0.65860142, 0.65453358,
0.65068745, 0.64705586, 0.64363176, 0.64040825, 0.6373786,
0.63453627, 0.63187493, 0.62938846, 0.62707102, 0.62491699,
0.62292104, 0.62107811, 0.61938343, 0.61783254, 0.61642126,
0.61514575, 0.61400248, 0.61298823, 0.61210013, 0.61133562,
0.6106925, 0.61016887, 0.60976321, 0.6094743, 0.60930131,
0.6092437, 0.60930131, 0.6094743, 0.60976321, 0.61016887,
0.6106925, 0.61133562, 0.61210013, 0.61298823, 0.61400248,
0.61514575, 0.61642126, 0.61783254, 0.61938343, 0.62107811,
0.62292104, 0.62491699, 0.62707102, 0.62938846, 0.63187493,
0.63453627, 0.6373786, 0.64040825, 0.64363176, 0.64705586,
0.65068745, 0.65453358, 0.65860142, 0.66289825, 0.66743139,
0.67220822, 0.67723609, 0.68252235, 0.68807425, 0.69389894,
0.7000034, 0.70639441, 0.71307849, 0.72006187, 0.7273504,
0.73494955, 0.74286428, 0.75109905, 0.75965773, 0.76854352,
0.77775892, 0.78730566, 0.79718461, 0.80739577, 0.81793812,
0.82880966, 0.84000728, 0.85152672, 0.86336251, 0.87550792,
0.88795492, 0.90069412, 0.91371473, 0.92700453, 0.94054983,
0.95433545, 0.96834473, 0.98255947, 0.99695997, 1.01152502,
1.02623195, 1.04105658, 1.05597334, 1.07095529, 1.08597415,
1.10100039, 1.11600331, 1.13095114, 1.14581109, 1.16054952,
1.17513203, 1.18952357, 1.20368862, 1.21759129, 1.2311955,
1.24446514, 1.25736421, 1.269857, 1.28190828, 1.29348345,
1.30454871, 1.31507127, 1.32501947, 1.334363, 1.34307303,
1.35112239, 1.3584857, 1.36513953, 1.37106255, 1.37623562,
1.38064191, 1.38426701, 1.38709902, 1.3891286, 1.39034904,
1.3907563]

z_bound = [0.00000000e+00, 2.17126212e-02, 4.34038147e-02, 6.50521739e-02,
8.66363344e-02, 1.08134995e-01, 1.29526940e-01, 1.50791057e-01,
1.71906362e-01, 1.92852016e-01, 2.13607348e-01, 2.34151876e-01,
2.54465324e-01, 2.74527645e-01, 2.94319041e-01, 3.13819979e-01,
3.33011215e-01, 3.51873809e-01, 3.70389146e-01, 3.88538954e-01,
4.06305321e-01, 4.23670713e-01, 4.40617994e-01, 4.57130438e-01,
4.73191749e-01, 4.88786077e-01, 5.03898032e-01, 5.18512701e-01,
5.32615660e-01, 5.46192992e-01, 5.59231298e-01, 5.71717709e-01,
5.83639905e-01, 5.94986118e-01, 6.05745152e-01, 6.15906388e-01,
6.25459799e-01, 6.34395957e-01, 6.42706043e-01, 6.50381855e-01,
6.57415819e-01, 6.63800993e-01, 6.69531075e-01, 6.74600411e-01,
6.79003998e-01, 6.82737490e-01, 6.85797203e-01, 6.88180116e-01,
6.89883879e-01, 6.90906810e-01, 6.91247899e-01, 6.90906810e-01,
6.89883879e-01, 6.88180116e-01, 6.85797203e-01, 6.82737490e-01,
6.79003998e-01, 6.74600411e-01, 6.69531075e-01, 6.63800993e-01,
6.57415819e-01, 6.50381855e-01, 6.42706043e-01, 6.34395957e-01,
6.25459799e-01, 6.15906388e-01, 6.05745152e-01, 5.94986118e-01,
5.83639905e-01, 5.71717709e-01, 5.59231298e-01, 5.46192992e-01,
5.32615660e-01, 5.18512701e-01, 5.03898032e-01, 4.88786077e-01,
4.73191749e-01, 4.57130438e-01, 4.40617994e-01, 4.23670713e-01,
4.06305321e-01, 3.88538954e-01, 3.70389146e-01, 3.51873809e-01,
3.33011215e-01, 3.13819979e-01, 2.94319041e-01, 2.74527645e-01,
2.54465324e-01, 2.34151876e-01, 2.13607348e-01, 1.92852016e-01,
1.71906362e-01, 1.50791057e-01, 1.29526940e-01, 1.08134995e-01,
8.66363344e-02, 6.50521739e-02, 4.34038147e-02, 2.17126212e-02,
-2.22322281e-16, -2.17126212e-02, -4.34038147e-02, -6.50521739e-02,
-8.66363344e-02, -1.08134995e-01, -1.29526940e-01, -1.50791057e-01,
-1.71906362e-01, -1.92852016e-01, -2.13607348e-01, -2.34151876e-01,
-2.54465324e-01, -2.74527645e-01, -2.94319041e-01, -3.13819979e-01,
-3.33011215e-01, -3.51873809e-01, -3.70389146e-01, -3.88538954e-01,
-4.06305321e-01, -4.23670713e-01, -4.40617994e-01, -4.57130438e-01,
-4.73191749e-01, -4.88786077e-01, -5.03898032e-01, -5.18512701e-01,
-5.32615660e-01, -5.46192992e-01, -5.59231298e-01, -5.71717709e-01,
-5.83639905e-01, -5.94986118e-01, -6.05745152e-01, -6.15906388e-01,
-6.25459799e-01, -6.34395957e-01, -6.42706043e-01, -6.50381855e-01,
-6.57415819e-01, -6.63800993e-01, -6.69531075e-01, -6.74600411e-01,
-6.79003998e-01, -6.82737490e-01, -6.85797203e-01, -6.88180116e-01,
-6.89883879e-01, -6.90906810e-01, -6.91247899e-01, -6.90906810e-01,
-6.89883879e-01, -6.88180116e-01, -6.85797203e-01, -6.82737490e-01,
-6.79003998e-01, -6.74600411e-01, -6.69531075e-01, -6.63800993e-01,
-6.57415819e-01, -6.50381855e-01, -6.42706043e-01, -6.34395957e-01,
-6.25459799e-01, -6.15906388e-01, -6.05745152e-01, -5.94986118e-01,
-5.83639905e-01, -5.71717709e-01, -5.59231298e-01, -5.46192992e-01,
-5.32615660e-01, -5.18512701e-01, -5.03898032e-01, -4.88786077e-01,
-4.73191749e-01, -4.57130438e-01, -4.40617994e-01, -4.23670713e-01,
-4.06305321e-01, -3.88538954e-01, -3.70389146e-01, -3.51873809e-01,
-3.33011215e-01, -3.13819979e-01, -2.94319041e-01, -2.74527645e-01,
-2.54465324e-01, -2.34151876e-01, -2.13607348e-01, -1.92852016e-01,
-1.71906362e-01, -1.50791057e-01, -1.29526940e-01, -1.08134995e-01,
-8.66363344e-02, -6.50521739e-02, -4.34038147e-02, -2.17126212e-02,
0.0]

mode = 82
rho_psi = [0.0, 0.00555556, 0.01111111, 0.01666667, 0.02222222,
0.02777778, 0.03333333, 0.03888889, 0.04444444, 0.05,
0.05555556, 0.06111111, 0.06666667, 0.07222222, 0.07777778,
0.08333333, 0.08888889, 0.09444444, 0.1, 0.10555556,
0.11111111, 0.11666667, 0.12222222, 0.12777778, 0.13333333,
0.13888889, 0.14444444, 0.15, 0.15555556, 0.16111111,
0.16666667, 0.17222222, 0.17777778, 0.18333333, 0.18888889,
0.19444444, 0.2, 0.20555556, 0.21111111, 0.21666667,
0.22222222, 0.22777778, 0.23333333, 0.23888889, 0.24444444,
0.25, 0.25555556, 0.26111111, 0.26666667, 0.27222222,
0.27777778, 0.28333333, 0.28888889, 0.29444444, 0.3,
0.30555556, 0.31111111, 0.31666667, 0.32222222, 0.32777778,
0.33333333, 0.33888889, 0.34444444, 0.35, 0.35555556,
0.36111111, 0.36666667, 0.37222222, 0.37777778, 0.38333333,
0.38888889, 0.39444444, 0.4, 0.40555556, 0.41111111,
0.41666667, 0.42222222, 0.42777778, 0.43333333, 0.43888889,
0.44444444, 0.45, 0.45555556, 0.46111111, 0.46666667,
0.47222222, 0.47777778, 0.48333333, 0.48888889, 0.49444444,
0.5, 0.50555556, 0.51111111, 0.51666667, 0.52222222,
0.52777778, 0.53333333, 0.53888889, 0.54444444, 0.55,
0.55555556, 0.56111111, 0.56666667, 0.57222222, 0.57777778,
0.58333333, 0.58888889, 0.59444444, 0.6, 0.60555556,
0.61111111, 0.61666667, 0.62222222, 0.62777778, 0.63333333,
0.63888889, 0.64444444, 0.65, 0.65555556, 0.66111111,
0.66666667, 0.67222222, 0.67777778, 0.68333333, 0.68888889,
0.69444444, 0.7, 0.70555556, 0.71111111, 0.71666667,
0.72222222, 0.72777778, 0.73333333, 0.73888889, 0.74444444,
0.75, 0.75555556, 0.76111111, 0.76666667, 0.77222222,
0.77777778, 0.78333333, 0.78888889, 0.79444444, 0.8,
0.80555556, 0.81111111, 0.81666667, 0.82222222, 0.82777778,
0.83333333, 0.83888889, 0.84444444, 0.85, 0.85555556,
0.86111111, 0.86666667, 0.87222222, 0.87777778, 0.88333333,
0.88888889, 0.89444444, 0.9, 0.90555556, 0.91111111,
0.91666667, 0.92222222, 0.92777778, 0.93333333, 0.93888889,
0.94444444, 0.95, 0.95555556, 0.96111111, 0.96666667,
0.97222222, 0.97777778, 0.98333333, 0.98888889, 0.99444444,
1.0]

pressure = [1.73757324e-02, 1.73762864e-02, 1.73762957e-02, 1.73757499e-02,
1.73746388e-02, 1.73729521e-02, 1.73706795e-02, 1.73678109e-02,
1.73643358e-02, 1.73602441e-02, 1.73555255e-02, 1.73501697e-02,
1.73441664e-02, 1.73375054e-02, 1.73301764e-02, 1.73221691e-02,
1.73134733e-02, 1.73040787e-02, 1.72939751e-02, 1.72831520e-02,
1.72715994e-02, 1.72593069e-02, 1.72462643e-02, 1.72324610e-02,
1.72178814e-02, 1.72025046e-02, 1.71863096e-02, 1.71692752e-02,
1.71513805e-02, 1.71326096e-02, 1.71129522e-02, 1.70923984e-02,
1.70709382e-02, 1.70485698e-02, 1.70253101e-02, 1.70011790e-02,
1.69761955e-02, 1.69503556e-02, 1.69236272e-02, 1.68959764e-02,
1.68673747e-02, 1.68378133e-02, 1.68072877e-02, 1.67757949e-02,
1.67433394e-02, 1.67099279e-02, 1.66755705e-02, 1.66402902e-02,
1.66041129e-02, 1.65670437e-02, 1.65290483e-02, 1.64900909e-02,
1.64501561e-02, 1.64092416e-02, 1.63673459e-02, 1.63244687e-02,
1.62806112e-02, 1.62357809e-02, 1.61899880e-02, 1.61432417e-02,
1.60955518e-02, 1.60469387e-02, 1.59974350e-02, 1.59470409e-02,
1.58957122e-02, 1.58433821e-02, 1.57899590e-02, 1.57355074e-02,
1.56802827e-02, 1.56242811e-02, 1.55672456e-02, 1.55091637e-02,
1.54501813e-02, 1.53903629e-02, 1.53296974e-02, 1.52680489e-02,
1.52054110e-02, 1.51419683e-02, 1.50776978e-02, 1.50124807e-02,
1.49463217e-02, 1.48793356e-02, 1.48116607e-02, 1.47430154e-02,
1.46733201e-02, 1.46029789e-02, 1.45318956e-02, 1.44598762e-02,
1.43869653e-02, 1.43133296e-02, 1.42390053e-02, 1.41638467e-02,
1.40878167e-02, 1.40110109e-02, 1.39335582e-02, 1.38554567e-02,
1.37765083e-02, 1.36967400e-02, 1.36163384e-02, 1.35352862e-02,
1.34536099e-02, 1.33712335e-02, 1.32881192e-02, 1.32043753e-02,
1.31200376e-02, 1.30351101e-02, 1.29496131e-02, 1.28635180e-02,
1.27767978e-02, 1.26895343e-02, 1.26017525e-02, 1.25134636e-02,
1.24246785e-02, 1.23354142e-02, 1.22456693e-02, 1.21554551e-02,
1.20648171e-02, 1.19737701e-02, 1.18823301e-02, 1.17905131e-02,
1.16983358e-02, 1.16058138e-02, 1.15129848e-02, 1.14198710e-02,
1.13264832e-02, 1.12328397e-02, 1.11389598e-02, 1.10448631e-02,
1.09505723e-02, 1.08560989e-02, 1.07615262e-02, 1.06668681e-02,
1.05721157e-02, 1.04772893e-02, 1.03824128e-02, 1.02875086e-02,
1.01925997e-02, 1.00977211e-02, 1.00030053e-02, 9.90840744e-03,
9.81392000e-03, 9.71957057e-03, 9.62538651e-03, 9.53138411e-03,
9.43768885e-03, 9.34440355e-03, 9.25141381e-03, 9.15874574e-03,
9.06642044e-03, 8.97450593e-03, 8.88327521e-03, 8.79255096e-03,
8.70231301e-03, 8.61256251e-03, 8.52368357e-03, 8.43559738e-03,
8.34811122e-03, 8.26138641e-03, 8.17583585e-03, 8.09110021e-03,
8.00714247e-03, 7.92481330e-03, 7.84321894e-03, 7.76313778e-03,
7.68437293e-03, 7.60698768e-03, 7.53138894e-03, 7.45727610e-03,
7.38499739e-03, 7.31453014e-03, 7.24495298e-03, 7.17505773e-03,
7.09871723e-03, 7.00095927e-03, 6.83553011e-03, 6.47085716e-03,
5.70155080e-03, 4.11748091e-03, 2.04200575e-03, 5.83243601e-04,
5.34911694e-05]

j_tor = [1.25152298, 1.25169519, 1.25186306, 1.25202169, 1.25216621,
1.25229174, 1.2523934, 1.25246631, 1.25250559, 1.25250636,
1.25246373, 1.25237284, 1.25222879, 1.25202672, 1.25176173,
1.25142895, 1.25102351, 1.25054051, 1.24997508, 1.24932234,
1.2485774, 1.2477354, 1.24679145, 1.24574086, 1.24458342,
1.24332337, 1.24196517, 1.24051325, 1.23897201, 1.23734393,
1.23562929, 1.23382826, 1.231941, 1.22996643, 1.22790057,
1.22573902, 1.22347751, 1.22111602, 1.21865973, 1.21611413,
1.21348329, 1.21076608, 1.20796018, 1.20506422, 1.20208204,
1.19901913, 1.1958785, 1.19265305, 1.18933319, 1.18591427,
1.1824006, 1.17879712, 1.17510479, 1.17132219, 1.16745083,
1.16349827, 1.15947055, 1.15536087, 1.1511585, 1.14685954,
1.14246488, 1.13797614, 1.13339573, 1.12873064, 1.12399382,
1.11918411, 1.1142797, 1.10927168, 1.10416996, 1.09898719,
1.09373519, 1.08839755, 1.08294724, 1.07741087, 1.07181472,
1.06612083, 1.06031803, 1.05444465, 1.04849438, 1.04244271,
1.03630013, 1.03007913, 1.02378215, 1.01738933, 1.01089697,
1.00433366, 0.99768964, 0.99094874, 0.9841147, 0.97720154,
0.97021243, 0.96313441, 0.95596046, 0.94869701, 0.94135648,
0.93394106, 0.92643021, 0.91882436, 0.91113956, 0.90337194,
0.89552539, 0.88759482, 0.87957023, 0.871453, 0.8632588,
0.8549881, 0.84663392, 0.8381951, 0.82966729, 0.82104186,
0.81234349, 0.80356601, 0.79470938, 0.78577, 0.7767459,
0.76763352, 0.75842879, 0.74914754, 0.73978887, 0.73035374,
0.7208362, 0.71123885, 0.70155966, 0.69179044, 0.68192866,
0.67199607, 0.66199104, 0.65190769, 0.64174647, 0.63150494,
0.62118435, 0.61077957, 0.60028052, 0.58970745, 0.57907215,
0.56836138, 0.55757523, 0.54671066, 0.53576897, 0.52473353,
0.51361428, 0.50244101, 0.49120242, 0.47989133, 0.46850229,
0.45702278, 0.44545142, 0.43383907, 0.42216826, 0.4104254,
0.39858101, 0.38665013, 0.37469443, 0.36268174, 0.35055907,
0.33834773, 0.32613097, 0.31383126, 0.3014142, 0.2889852,
0.27648719, 0.26387341, 0.25126102, 0.23851723, 0.22575432,
0.21289967, 0.20001503, 0.18703944, 0.17408994, 0.16128881,
0.14891858, 0.13814368, 0.13191485, 0.13704904, 0.17450124,
0.29227162, 0.5045926, 0.73608715, 0.70785369, 0.329137,
0.03669814]

ϵ = 0.39075563
z_axis = 4.9326164e-07
pressure_sep = 5.34911694251647e-05
Bt_center = 2.469
r_center = 1.6469995
Ip = 1e6


# CHEASE units to SI units
pressure_sep *=  (Bt_center^2 / μ_0)
pressure .*=  (Bt_center^2 / μ_0)
j_tor .*=  Bt_center / (r_center * μ_0)
r_bound .*= r_center
z_bound .*= r_center

gEQDSK = run_chease(ϵ, z_axis, pressure_sep, Bt_center, r_center, Ip, r_bound, z_bound, mode, rho_psi, pressure, j_tor,keep_output=false)

println("q_profile", gEQDSK.qpsi)